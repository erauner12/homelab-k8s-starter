version: "3"

vars:
  HOME_BOOTSTRAP_PATH: clusters/home/bootstrap
  CLOUD_BOOTSTRAP_PATH: clusters/cloud/bootstrap
  GOTK_SYNC: '{{.HOME_BOOTSTRAP_PATH}}/kustomization.yaml'
  TOOLS_SCRIPT: hack/install-tools.sh

tasks:
  # Tool installation
  tools:install:
    desc: Install helper tools (kubeconform, etc.)
    cmds:
      - bash {{.TOOLS_SCRIPT}}

  lint:
    desc: Run full golangci-lint (comprehensive, local development)
    cmds:
      - golangci-lint run --timeout=3m

  lint:ci:
    desc: Run fast golangci-lint (balanced linters for PRs, matches CI)
    cmds:
      - golangci-lint run --config=.golangci-ci.yml --timeout=2m

  lint:release:
    desc: Run comprehensive golangci-lint (full analysis for main/master)
    cmds:
      - golangci-lint run --config=.golangci-release.yml --timeout=5m

  build:
    desc: Build all Go packages (same as CI)
    cmds:
      - go build ./...

  ci-check:
    desc: Run both lint and build checks like CI
    deps:
      - lint
      - build

  test:
    desc: Run Go tests
    cmds:
      - go test ./...

  test-verbose:
    desc: Run Go tests with verbose output
    cmds:
      - go test -v ./...

  # Essential CI/CD tasks
  go-tidy:
    desc: Tidy and verify Go modules
    cmds:
      - go mod tidy
      - go mod verify

  clean:
    desc: Clean Go build cache and test cache
    cmds:
      - go clean -cache -modcache -testcache

  # Kustomize validation
  kustomize-build-all:
    desc: Build all kustomize configurations (quiet by default; see hack/kustomize-build.sh for ENV flags)
    deps:
      - tools:install
    vars:
      DIRS:
        - infrastructure/base
        - infrastructure/home
        - infrastructure/cloud
        - infrastructure/test/synology-csi/minimal
        - "{{.HOME_BOOTSTRAP_PATH}}"
        - "{{.CLOUD_BOOTSTRAP_PATH}}"
    cmds:
      - |
        export VERBOSE="${VERBOSE:-}"
        export SUMMARY="${SUMMARY:-}"
        export ONLY="${ONLY:-}"
        export CHECK_SCHEMA="${CHECK_SCHEMA:-}"
        export N_TAIL="${N_TAIL:-}"
        bash hack/kustomize-build.sh {{.DIRS | join " "}}

  kustomize-build-all-verbose:
    desc: Build all kustomize configurations with full output (for debugging)
    cmds:
      - VERBOSE=1 task kustomize-build-all

  kustomize-summary:
    desc: Build all kustomize configurations with object count summary
    cmds:
      - SUMMARY=1 task kustomize-build-all

  kustomize-validate-schema:
    desc: Build and validate all kustomize configurations with kubeconform
    deps:
      - tools:install
    cmds:
      - CHECK_SCHEMA=1 task kustomize-build-all

  # Kustomize server-side dry-run validation
  kustomize:dry-run:
    desc: "Render app overlays (or CLI-specified paths) and kubectl server-side dry-run apply"
    deps: [tools:install]
    cmds:
      - |
        # Gather directories: from CLI args, or discover all apps/*/overlays/*
        DIRS="{{.CLI_ARGS}}"
        if [ -z "$DIRS" ]; then
          DIRS=$(find apps -type f -name kustomization.yaml -path '*/overlays/*' | sed 's|/[^/]*$||' | sort -u | tr '\n' ' ')
        fi
        DRY_RUN_APPLY=1 bash hack/kustomize-build.sh $DIRS

  kustomize:dry-run-verbose:
    desc: "Same as kustomize:dry-run but with full YAML output"
    deps: [tools:install]
    cmds:
      - |
        DIRS="{{.CLI_ARGS}}"
        if [ -z "$DIRS" ]; then
          DIRS=$(find apps -type f -name kustomization.yaml -path '*/overlays/*' | sed 's|/[^/]*$||' | sort -u | tr '\n' ' ')
        fi
        VERBOSE=1 DRY_RUN_APPLY=1 bash hack/kustomize-build.sh $DIRS

  # Helm validation
  helm:validate-all:
    desc: Validate every HelmRelease by templating charts (no cluster needed)
    cmds:
      - bash hack/validate-helmreleases.sh

  helm:template-all:
    desc: "Legacy alias for helm:validate-all"
    cmds:
      - task: helm:validate-all

  helm:validate-production:
    desc: Validate HelmReleases excluding test charts (for CI/production validation)
    cmds:
      - SKIP_TEST_CHARTS=1 bash hack/validate-helmreleases.sh

  helm:template-production:
    desc: "Legacy alias for helm:validate-production"
    cmds:
      - task: helm:validate-production

  validate:variables:
    desc: "Validate kustomize variable substitutions and detect common configuration issues"
    cmds:
      - bash scripts/validate-variables.sh

  validate:sops:
    desc: "Validate all SOPS encrypted files can be decrypted and check for hardcoded passwords"
    cmds:
      - bash -c 'export SOPS_AGE_KEY="${SOPS_AGE_KEY:?SOPS_AGE_KEY environment variable must be set}"; ./scripts/sops.sh validate-all'

  validate:sops-list:
    desc: "List all SOPS encrypted files in the repository"
    cmds:
      - ./scripts/sops.sh list-secrets

  validate:sops-diff:
    desc: "Compare SOPS files between production and staging (requires CLI_ARGS='file1 file2')"
    cmds:
      - bash -c 'export SOPS_AGE_KEY="${SOPS_AGE_KEY:?SOPS_AGE_KEY environment variable must be set}"; ./scripts/sops.sh diff {{.CLI_ARGS}}'

  validate:layers:
    desc: "Validate GitOps layer taxonomy - ensures resources are in correct layers (infra/stack/policy)"
    cmds:
      - go run ./cmd/homelabctl validate layers . --exclude "**/.git/**" --exclude "**/testdata/**"

  validate:manifests:
    desc: "Validate YAML syntax, Kustomize builds, and Kubernetes schemas using homelabctl"
    cmds:
      - go run ./cmd/homelabctl validate manifests . --exclude "**/.git/**" --exclude "**/testdata/**" --exclude "**/*.sops.yaml"

  check:sync-status:
    desc: "Check if FluxCD kustomizations are synced to latest git commit"
    cmds:
      - bash scripts/check-sync-status.sh

  test:validate-variables:
    desc: "Test the variable validation script to ensure it catches problematic configurations"
    cmds:
      - bash scripts/test-validate-variables.sh

  # Individual test suites
  test-synology-csi:
    desc: Run Synology CSI tests only
    cmds:
      - go test -v ./test/synologycsi/... -timeout 15m

  test-flux:
    desc: Run Flux tests only
    cmds:
      - go test -v ./test/flux/... -timeout 15m

  # CLI build
  build-cli:
    desc: Build homelabctl CLI binary for validation and other tools
    cmds:
      - go build -o bin/homelabctl -ldflags="-X main.version=dev -X main.commit=$(git rev-parse HEAD)" ./cmd/homelabctl

  install-cli:
    desc: Build and install homelabctl CLI to /usr/local/bin (requires sudo)
    deps: [build-cli]
    cmds:
      - sudo cp bin/homelabctl /usr/local/bin/
      - echo "homelabctl installed to /usr/local/bin/"

  # Go development tasks
  go:format:
    desc: "Format Go code with gofmt"
    cmds:
      - gofmt -s -w .

  go:lint:
    desc: "Run golangci-lint locally (full comprehensive linting)"
    deps: [tools:install]
    cmds:
      - golangci-lint run --timeout=3m

  go:lint:ci:
    desc: "Run golangci-lint with CI config (fast, minimal linters)"
    deps: [tools:install]
    cmds:
      - golangci-lint run --config=.golangci-ci.yml --timeout=3m

  go:lint:fix:
    desc: "Run golangci-lint with auto-fix"
    deps: [tools:install]
    cmds:
      - golangci-lint run --timeout=3m --fix

  go:test:
    desc: "Run all Go tests (including integration tests)"
    cmds:
      - go test ./...

  go:test-unit:
    desc: "Run unit tests only (excludes integration tests)"
    cmds:
      - go test ./... -short

  go:build:
    desc: "Build the CLI tool"
    cmds:
      - go build -o bin/homelabctl ./cmd/homelabctl

  # Pre-commit validation tasks
  pre-commit:
    desc: "Run pre-commit hooks (default: fast mode locally, full in CI)"
    cmds:
      - pre-commit run --all-files

  pre-commit:full:
    desc: "Run comprehensive pre-commit validation (all checks)"
    cmds:
      - PRE_COMMIT_FULL=1 pre-commit run --all-files

  pre-commit:verbose:
    desc: "Run pre-commit hooks with verbose output"
    cmds:
      - PRE_COMMIT_VERBOSE=1 pre-commit run --all-files

  pre-commit:fast:
    desc: "Force fast mode pre-commit checks (minimal validation)"
    cmds:
      - PRE_COMMIT_FAST=1 pre-commit run --all-files

  lint:suspended-check:
    desc: "Check suspended components across deployments (set FAIL_ON_SUSPENDED=true to enforce no suspension)"
    cmds:
      - bash hack/check-suspended.sh
    silent: false

  lint:loadbalancer-policy:
    desc: "Check LoadBalancer services have BGP-compliant externalTrafficPolicy: Local"
    cmds:
      - bash hack/check-lbs.sh
    silent: false

  pre-commit-full:
    desc: "Run full pre-commit checks with verbose output (deprecated: use pre-commit:full)"
    cmds:
      - task pre-commit:full

  # CRD management
  crd:update-flux:
    desc: "Update vendored Flux CRD schemas to the latest version"
    cmds:
      - bash hack/update-crd-schemas.sh flux


  # Kind cluster cleanup
  kind-cleanup:
    desc: Clean up any leftover Kind clusters
    cmds:
      - |
        kind get clusters 2>/dev/null | grep -E "(synology-csi-test|flux-test)" | xargs -r -n1 kind delete cluster --name || true

  # Integration tests (disabled in CI, run manually)
  test-integration:
    desc: Run full integration tests with Kind clusters (same as CI but local)
    cmds:
      - go test ./test/... -v -timeout 45m -tags integration
    env:
      SKIP_TEARDOWN: "false"

  test-integration-keep:
    desc: Run integration tests but keep clusters for debugging
    cmds:
      - go test ./test/... -v -timeout 45m -tags integration
    env:
      SKIP_TEARDOWN: "true"

  # E2E bootstrap tests
  test:e2e:
    desc: Run E2E bootstrap tests on a disposable Kind cluster
    deps: [build-cli]          # ensure ./bin/homelabctl is up-to-date if you black-box test
    cmds:
      - go test ./test/e2e -v -count=1 -timeout=20m

  test:e2e:verbose:
    desc: Run E2E bootstrap tests with verbose output
    deps: [build-cli]
    cmds:
      - go test ./test/e2e -v -count=1 -timeout=20m -test.v

  test:e2e:keep:
    desc: Run E2E bootstrap tests but keep clusters for debugging
    deps: [build-cli]
    cmds:
      - SKIP_TEARDOWN=true go test ./test/e2e -v -count=1 -timeout=20m

  test:e2e:bootstrap:
    desc: Run only the basic bootstrap test
    deps: [build-cli]
    cmds:
      - go test ./test/e2e -v -count=1 -timeout=15m -run TestBootstrapOnKind

  test:e2e:idempotency:
    desc: Run only the idempotency test
    deps: [build-cli]
    cmds:
      - go test ./test/e2e -v -count=1 -timeout=15m -run TestBootstrapIdempotency

  # Bootstrap tasks
  bootstrap:plan:
    desc: Show what bootstrap would do (dry-run)
    deps: [build-cli]
    cmds:
      - ./bin/homelabctl bootstrap plan

  bootstrap:run:
    desc: Run complete homelab bootstrap process
    deps: [build-cli]
    cmds:
      - ./bin/homelabctl bootstrap run

  bootstrap:kind:
    desc: Bootstrap a local Kind cluster for testing
    deps: [build-cli]
    cmds:
      - ./bin/homelabctl bootstrap run --test-mode --environment kind

  bootstrap:resume:
    desc: Resume interrupted bootstrap process
    deps: [build-cli]
    cmds:
      - ./bin/homelabctl bootstrap resume

  # Kyverno policy testing
  kyverno:version:
    desc: Show Kyverno CLI version
    cmds:
      - kyverno version
    silent: false

  kyverno:test:
    desc: Run Kyverno policy unit tests
    cmds:
      - cmd: |
          echo "ğŸ” Running Kyverno policy unit tests..."
          ./infrastructure/base/kyverno-policies/tests/run-kyverno-tests.sh
    silent: false

  kyverno:test:verbose:
    desc: Run Kyverno policy tests with verbose output
    cmds:
      - kyverno test infrastructure/base/kyverno-policies/tests/native

  kyverno:apply:dry-run:
    desc: Test policy application without actually applying
    cmds:
      - cmd: |
          echo "ğŸ§ª Testing policy application (dry-run)..."
          echo "â„¹ï¸  Use 'kyverno test infrastructure/base/kyverno-policies/tests/native' for comprehensive testing"
          echo "   Native test suite provides detailed validation with expected results."

  kyverno:test:enhanced:
    desc: Run enhanced Kyverno policy tests with structured test definitions
    cmds:
      - cmd: |
          echo "ğŸ” Running enhanced Kyverno policy tests..."
          ./infrastructure/base/kyverno-policies/tests/run-enhanced-tests.sh
    silent: false

  kyverno:test:native:
    desc: Run native Kyverno test suite (recommended)
    cmds:
      - cmd: |
          echo "ğŸ›¡ï¸  Running native Kyverno test suite..."
          kyverno test infrastructure/base/kyverno-policies/tests/native --detailed-results
    silent: false
